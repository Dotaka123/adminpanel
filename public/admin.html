<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Admin - Proxy Shop</title>
    <style>
        * {margin:0; padding:0; box-sizing:border-box;}
        body {font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); min-height:100vh; padding:20px;}
        .container {max-width:1400px; margin:0 auto;}
        .header {background:white; padding:20px 30px; border-radius:15px; box-shadow:0 10px 30px rgba(0,0,0,0.2); margin-bottom:30px; display:flex; justify-content:space-between; align-items:center;}
        .header h1 {color:#667eea; font-size:28px; font-weight: 800;}
        .brand-name-color {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .logout-btn {background:#f44336; color:white; border:none; padding:10px 20px; border-radius:8px; cursor:pointer; font-size:14px;}
        .stats-grid {display:grid; grid-template-columns:repeat(auto-fit,minmax(250px,1fr)); gap:20px; margin-bottom:30px;}
        .stat-card {background:white; padding:25px; border-radius:15px; box-shadow:0 10px 30px rgba(0,0,0,0.1); text-align:center;}
        .stat-card h3 {color:#666; font-size:14px; margin-bottom:10px;}
        .stat-card .number {font-size:36px; font-weight:bold; color:#667eea;}
        .main-panel {background:white; padding:30px; border-radius:15px; box-shadow:0 10px 30px rgba(0,0,0,0.2);}
        .tabs {display:flex; gap:10px; margin-bottom:30px; border-bottom:2px solid #f0f0f0;}
        .tab {padding:12px 24px; background:none; border:none; cursor:pointer; font-size:16px; color:#666; border-bottom:3px solid transparent; transition:all 0.3s;}
        .tab.active {color:#667eea; border-bottom-color:#667eea;}
        .tab-content {display:none;}
        .tab-content.active {display:block;}
        .users-table {width:100%; border-collapse:collapse; margin-top:20px;}
        .users-table th {background:#f8f9fa; padding:15px; text-align:left; font-weight:600; color:#333;}
        .users-table td {padding:15px; border-bottom:1px solid #f0f0f0;}
        .users-table tr:hover {background:#f8f9fa;}
        .badge {padding:5px 10px; border-radius:20px; font-size:12px; font-weight:bold;}
        .badge.admin {background:#ffd700; color:#333;}
        .badge.user {background:#e3f2fd; color:#1976d2;}
        .btn {padding:8px 16px; border:none; border-radius:6px; cursor:pointer; font-size:14px; margin:0 5px; transition:all 0.3s;}
        .btn-success {background:#4caf50; color:white;}
        .btn-danger {background:#f44336; color:white;}
        .btn-primary {background:#667eea; color:white;}
        .btn:hover {opacity:0.8; transform:translateY(-2px);}
        .modal {display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;}
        .modal.active {display:flex;}
        .modal-content {background:white; padding:30px; border-radius:15px; width:90%; max-width:500px; box-shadow:0 20px 60px rgba(0,0,0,0.3);}
        .modal-content h2 {margin-bottom:20px; color:#333;}
        .form-group {margin-bottom:20px;}
        .form-group label {display:block; margin-bottom:8px; color:#666; font-weight:500;}
        .form-group input, .form-group textarea {width:100%; padding:12px; border:2px solid #e0e0e0; border-radius:8px; font-size:14px;}
        .form-group input:focus, .form-group textarea:focus {outline:none; border-color:#667eea;}
        .modal-buttons {display:flex; gap:10px; justify-content:flex-end; margin-top:20px;}
        .login-container {max-width:400px; margin:100px auto; background:white; padding:40px; border-radius:15px; box-shadow:0 10px 30px rgba(0,0,0,0.2);}
        .login-container h1 {text-align:center; color:#667eea; margin-bottom:30px;}
        .alert {padding:12px; border-radius:8px; margin-bottom:20px; font-size:14px;}
        .alert-success {background:#d4edda; color:#155724; border:1px solid #c3e6cb;}
        .alert-error {background:#f8d7da; color:#721c24; border:1px solid #f5c6cb;}
        .loading {text-align:center; padding:40px; color:#666;}
        /* Manual orders */
        .status-badge {padding:4px 10px; border-radius:12px; font-size:12px; font-weight:700; text-transform:uppercase;}
        .status-pending {background:#fff3cd; color:#856404;}
        .status-processing {background:#cce5ff; color:#004085;}
        .status-delivered {background:#d4edda; color:#155724;}
        .status-cancelled {background:#f8d7da; color:#721c24;}
        .order-notes {font-size:12px; color:#888; margin-top:4px; font-style:italic; max-width:200px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
        .type-chip {display:inline-block; padding:3px 8px; border-radius:6px; font-size:11px; font-weight:700;}
        .type-datacenter {background:#e3f0ff; color:#1a56db;}
        .type-residential {background:#ecfdf5; color:#047857;}
        .type-residential_pro {background:#f3e8ff; color:#6d28d9;}
        .type-static_isp {background:#e0f7fa; color:#00796b;}
        .stat-card.pending .number {color:#f59e0b;}
        .deliver-modal-content {background:white; padding:30px; border-radius:15px; width:90%; max-width:550px; box-shadow:0 20px 60px rgba(0,0,0,0.3);}
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <h1>üîê Admin Panel - <span class="brand-name-color">Proxy Shop</span></h1>
        <div id="loginAlert"></div>
        <form id="loginForm">
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="loginEmail" required placeholder="admin@proxyshop.com">
            </div>
            <div class="form-group">
                <label>Mot de passe</label>
                <input type="password" id="loginPassword" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            </div>
            <button type="submit" class="btn btn-primary" style="width:100%; padding:15px;">Se connecter</button>
        </form>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" style="display:none;">
        <div class="container">
            <div class="header">
                <div>
                    <h1>üëë Panel Admin - <span class="brand-name-color">Proxy Shop</span></h1>
                    <p style="color:#666; margin-top:5px;">Bienvenue, <span id="adminEmail"></span></p>
                </div>
                <button class="logout-btn" onclick="logout()">D√©connexion</button>
            </div>

            <div class="stats-grid">
                <div class="stat-card"><h3>Total Utilisateurs</h3><div class="number" id="totalUsers">0</div></div>
                <div class="stat-card"><h3>Total Proxies Vendus</h3><div class="number" id="totalProxies">0</div></div>
                <div class="stat-card"><h3>Revenus Totaux</h3><div class="number" id="totalRevenue">$0</div></div>
                <div class="stat-card pending"><h3>Commandes en attente</h3><div class="number" id="pendingOrders" style="color:#f59e0b;">0</div></div>
            </div>

            <div class="main-panel">
                <div class="tabs">
                    <button class="tab active" onclick="switchTab('users')">üë• Utilisateurs</button>
                    <button class="tab" onclick="switchTab('transactions')">üí∞ Transactions</button>
                    <button class="tab" onclick="switchTab('recharges')">üí≥ Recharges</button>
                    <button class="tab" onclick="switchTab('manualOrders')">üì¶ Commandes Manuelles</button>
                </div>

                <!-- Users Tab -->
                <div id="usersTab" class="tab-content active">
                    <div class="loading" id="usersLoading">Chargement...</div>
                    <table class="users-table" id="usersTable" style="display:none;">
                        <thead>
                            <tr>
                                <th>Email</th>
                                <th>Balance</th>
                                <th>R√¥le</th>
                                <th>Inscription</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody"></tbody>
                    </table>
                </div>

                <!-- Transactions Tab -->
                <div id="transactionsTab" class="tab-content">
                    <div class="loading">Transactions √† venir...</div>
                </div>

                <!-- Recharges Tab -->
                <div id="rechargesTab" class="tab-content">
                    <div class="loading" id="rechargesLoading">Chargement...</div>
                    <table class="users-table" id="rechargesTable" style="display:none;">
                        <thead>
                            <tr>
                                <th>Utilisateur</th>
                                <th>FaucetPay</th>
                                <th>Montant ($)</th>
                                <th>Date</th>
                                <th>Statut</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="rechargesTableBody"></tbody>
                    </table>
                </div>
            </div>

                <!-- Manual Orders Tab -->
                <div id="manualOrdersTab" class="tab-content">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                        <h3 style="color:#333;font-size:18px;">üì¶ Commandes Manuelles</h3>
                        <button class="btn btn-primary" onclick="loadManualOrders()" style="font-size:13px;">üîÑ Rafra√Æchir</button>
                    </div>
                    <div class="loading" id="manualOrdersLoading">Chargement...</div>
                    <div style="overflow-x:auto;">
                    <table class="users-table" id="manualOrdersTable" style="display:none;">
                        <thead>
                            <tr>
                                <th>Client</th>
                                <th>Type</th>
                                <th>Volume</th>
                                <th>Prix</th>
                                <th>Date</th>
                                <th>Notes client</th>
                                <th>Statut</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="manualOrdersTableBody"></tbody>
                    </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Cr√©dit -->
    <div id="creditModal" class="modal">
        <div class="modal-content">
            <h2>üíµ Ajouter du cr√©dit</h2>
            <div id="creditAlert"></div>
            <form id="creditForm">
                <input type="hidden" id="creditUserId">
                <div class="form-group"><label>Email utilisateur</label><input type="text" id="creditUserEmail" readonly></div>
                <div class="form-group"><label>Montant ($)</label><input type="number" id="creditAmount" step="0.01" min="0.01" required placeholder="0.25"></div>
                <div class="form-group"><label>Description (optionnel)</label><textarea id="creditDescription" rows="3" placeholder="Ex: Recharge manuelle"></textarea></div>
                <div class="modal-buttons">
                    <button type="button" class="btn btn-danger" onclick="closeModal()">Annuler</button>
                    <button type="submit" class="btn btn-success">Ajouter</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Livraison Commande Manuelle -->
    <div id="deliverModal" class="modal">
        <div class="deliver-modal-content">
            <h2>üì¶ Livrer la commande</h2>
            <p style="color:#666;font-size:14px;margin-bottom:20px;">Collez ici les credentials / informations de connexion √† transmettre au client.</p>
            <div id="deliverAlert"></div>
            <input type="hidden" id="deliverOrderId">
            <div class="form-group">
                <label>Informations de livraison (Host:Port:User:Pass ou autre)</label>
                <textarea id="deliveryNotes" rows="5" style="width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:8px;font-family:monospace;font-size:13px;" placeholder="ex: 1.2.3.4:8080:myuser:mypass&#10;ou&#10;host: proxy.example.com&#10;port: 8080&#10;user: john&#10;pass: secret123"></textarea>
            </div>
            <div class="modal-buttons">
                <button type="button" class="btn btn-danger" onclick="closeDeliverModal()">Annuler</button>
                <button type="button" class="btn btn-success" onclick="confirmDeliver()">‚úÖ Marquer comme livr√©</button>
            </div>
        </div>
    </div>

    <script>
        let token = localStorage.getItem('adminToken');
        let currentUser = null;

        // Login
        document.getElementById('loginForm').addEventListener('submit', async e => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            try {
                const res = await fetch('/api/auth/login', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({email,password})});
                const data = await res.json();
                if(!res.ok){showAlert('loginAlert', data.error || 'Erreur de connexion','error'); return;}
                if(!data.user.isAdmin){showAlert('loginAlert', 'Acc√®s refus√© - Admin requis','error'); return;}
                token = data.token; localStorage.setItem('adminToken', token); currentUser = data.user; showDashboard();
            } catch(err){showAlert('loginAlert','Erreur: '+err.message,'error');}
        });

        // Logout
        function logout(){localStorage.removeItem('adminToken'); token=null; currentUser=null; document.getElementById('dashboard').style.display='none'; document.getElementById('loginScreen').style.display='block';}

        // Dashboard
        async function showDashboard(){document.getElementById('loginScreen').style.display='none'; document.getElementById('dashboard').style.display='block'; document.getElementById('adminEmail').textContent=currentUser.email; await loadStats(); await loadUsers(); await loadRecharges();}

        // Stats
        async function loadStats(){try{const res=await fetch('/api/admin/stats',{headers:{'Authorization':`Bearer ${token}`}}); const data=await res.json(); document.getElementById('totalUsers').textContent=data.totalUsers||0; document.getElementById('totalProxies').textContent=data.totalProxies||0; document.getElementById('totalRevenue').textContent='$'+(data.totalRevenue||0).toFixed(2);}catch(err){console.error(err);}}

        // Users
        async function loadUsers(){try{const res=await fetch('/api/admin/users',{headers:{'Authorization':`Bearer ${token}`}}); const users=await res.json(); document.getElementById('usersLoading').style.display='none'; document.getElementById('usersTable').style.display='table'; const tbody=document.getElementById('usersTableBody'); tbody.innerHTML=users.map(u=>`<tr><td>${u.email}</td><td><strong>$${u.balance.toFixed(2)}</strong></td><td><span class="badge ${u.isAdmin?'admin':'user'}">${u.isAdmin?'Admin':'User'}</span></td><td>${new Date(u.createdAt).toLocaleDateString('fr-FR')}</td><td><button class="btn btn-success" onclick="openCreditModal('${u._id}','${u.email}')">+ Cr√©dit</button>${!u.isAdmin?`<button class="btn btn-primary" onclick="promoteUser('${u._id}')">Promouvoir</button>`:''}</td></tr>`).join('');}catch(err){console.error(err);}}

        // Recharges
        async function loadRecharges(){try{const res=await fetch('/api/admin/recharges',{headers:{'Authorization':`Bearer ${token}`}}); const requests=await res.json(); document.getElementById('rechargesLoading').style.display='none'; document.getElementById('rechargesTable').style.display='table'; const tbody=document.getElementById('rechargesTableBody'); tbody.innerHTML=requests.map(r=>`<tr><td>${r.userEmail}</td><td>${r.faucetpayUsername}</td><td>$${r.amount.toFixed(2)}</td><td>${new Date(r.createdAt).toLocaleString('fr-FR')}</td><td>${r.status}</td><td>${r.status==='pending'?`<button class="btn btn-success" onclick="validateRecharge('${r._id}')">Valider</button> <button class="btn btn-danger" onclick="rejectRecharge('${r._id}')">Rejeter</button>`:''}</td></tr>`).join('');}catch(err){console.error(err);}}

        // Validate / Reject Recharge
        async function validateRecharge(id){if(!confirm('Valider cette recharge?')) return; try{await fetch(`/api/admin/recharges/${id}/approve`,{method:'POST',headers:{'Authorization':`Bearer ${token}`,'Content-Type':'application/json'}}); loadRecharges(); loadUsers(); loadStats();}catch(err){alert(err.message);}}
        async function rejectRecharge(id){if(!confirm('Rejeter cette recharge?')) return; try{await fetch(`/api/admin/recharges/${id}/reject`,{method:'POST',headers:{'Authorization':`Bearer ${token}`,'Content-Type':'application/json'}}); loadRecharges();}catch(err){alert(err.message);}}

        // Credit modal
        function openCreditModal(id,email){document.getElementById('creditUserId').value=id; document.getElementById('creditUserEmail').value=email; document.getElementById('creditAmount').value=''; document.getElementById('creditDescription').value=''; document.getElementById('creditAlert').innerHTML=''; document.getElementById('creditModal').classList.add('active');}
        function closeModal(){document.getElementById('creditModal').classList.remove('active');}
        document.getElementById('creditForm').addEventListener('submit',async e=>{e.preventDefault(); const userId=document.getElementById('creditUserId').value; const amount=parseFloat(document.getElementById('creditAmount').value); const description=document.getElementById('creditDescription').value; try{const res=await fetch('/api/admin/add-credit',{method:'POST', headers:{'Authorization':`Bearer ${token}`,'Content-Type':'application/json'}, body:JSON.stringify({userId,amount,description})}); const data=await res.json(); if(!res.ok){showAlert('creditAlert',data.error||'Erreur','error'); return;} showAlert('creditAlert',`‚úÖ $${amount} ajout√© avec succ√®s!`,'success'); setTimeout(()=>{closeModal(); loadUsers(); loadStats();},1500);}catch(err){showAlert('creditAlert','Erreur: '+err.message,'error');}});

        // Promote
        async function promoteUser(id){if(!confirm('Promouvoir cet utilisateur en admin?')) return; try{await fetch('/api/admin/promote',{method:'POST', headers:{'Authorization':`Bearer ${token}`,'Content-Type':'application/json'}, body:JSON.stringify({userId:id})}); alert('‚úÖ Utilisateur promu en admin!'); loadUsers();}catch(err){alert(err.message);}}

        // Tabs
        function switchTab(tab){document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active')); document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active')); event.target.classList.add('active'); document.getElementById(tab+'Tab').classList.add('active');}

        // Alert
        function showAlert(el,msg,type){const e=document.getElementById(el); e.innerHTML=`<div class="alert alert-${type==='error'?'error':'success'}">${msg}</div>`;}

        // Init
        if(token){fetch('/api/auth/me',{headers:{'Authorization':`Bearer ${token}`}}).then(r=>r.json()).then(u=>{if(u.isAdmin){currentUser=u; showDashboard();}else{logout();}}).catch(()=>logout());}

        // ‚îÄ‚îÄ showDashboard override to also load manual orders
        const _origShow = showDashboard;
        async function showDashboard(){
            document.getElementById('loginScreen').style.display='none';
            document.getElementById('dashboard').style.display='block';
            document.getElementById('adminEmail').textContent=currentUser.email;
            await loadStats(); await loadUsers(); await loadRecharges(); await loadManualOrders();
        }

        // ‚îÄ‚îÄ Manual Orders ‚îÄ‚îÄ
        async function loadManualOrders() {
            try {
                const res = await fetch('/api/admin/manual-orders', {headers:{'Authorization':`Bearer ${token}`}});
                const orders = await res.json();
                document.getElementById('manualOrdersLoading').style.display = 'none';
                document.getElementById('manualOrdersTable').style.display = 'table';

                const pendingCount = orders.filter(o => o.status === 'pending').length;
                // Update stat card if exists
                const statEl = document.getElementById('pendingOrders');
                if (statEl) statEl.textContent = pendingCount;

                const tbody = document.getElementById('manualOrdersTableBody');
                if (!orders.length) {
                    tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;color:#999;padding:30px;">Aucune commande manuelle</td></tr>';
                    return;
                }

                const typeClass = {datacenter:'type-datacenter', residential:'type-residential', residential_pro:'type-residential_pro', static_isp:'type-static_isp'};

                tbody.innerHTML = orders.map(o => {
                    const statusClass = 'status-' + o.status;
                    const statusLabel = {pending:'En attente', processing:'En cours', delivered:'Livr√©', cancelled:'Annul√©'}[o.status] || o.status;
                    const tc = typeClass[o.type] || '';
                    const actions = o.status === 'pending'
                        ? `<button class="btn btn-primary" onclick="markProcessing('${o._id}')" style="font-size:12px;padding:5px 10px;">‚öôÔ∏è En cours</button>
                           <button class="btn btn-success" onclick="openDeliverModal('${o._id}')" style="font-size:12px;padding:5px 10px;">üì¶ Livrer</button>
                           <button class="btn btn-danger" onclick="cancelOrder('${o._id}')" style="font-size:12px;padding:5px 10px;">‚úñ Annuler</button>`
                        : o.status === 'processing'
                        ? `<button class="btn btn-success" onclick="openDeliverModal('${o._id}')" style="font-size:12px;padding:5px 10px;">üì¶ Livrer</button>
                           <button class="btn btn-danger" onclick="cancelOrder('${o._id}')" style="font-size:12px;padding:5px 10px;">‚úñ Annuler</button>`
                        : `<span style="color:#999;font-size:12px;">‚Äî</span>`;

                    return `<tr>
                        <td style="font-size:13px;">${o.userEmail}</td>
                        <td><span class="type-chip ${tc}">${o.typeLabel}</span></td>
                        <td style="font-weight:700;">${o.volume}</td>
                        <td style="font-weight:700;color:#667eea;">$${o.totalPrice.toFixed(2)}</td>
                        <td style="font-size:12px;color:#888;">${new Date(o.createdAt).toLocaleString('fr-FR')}</td>
                        <td><div class="order-notes" title="${o.notes || ''}">${o.notes || '‚Äî'}</div></td>
                        <td><span class="status-badge ${statusClass}">${statusLabel}</span></td>
                        <td>${actions}</td>
                    </tr>`;
                }).join('');
            } catch(err) { console.error(err); }
        }

        async function markProcessing(id) {
            try {
                const res = await fetch('/api/admin/manual-orders/' + id + '/processing', {method:'POST', headers:{'Authorization':`Bearer ${token}`,'Content-Type':'application/json'}});
                if (!res.ok) { const d = await res.json(); alert(d.error || 'Erreur'); return; }
                await loadManualOrders();
            } catch(err) { alert(err.message); }
        }

        function openDeliverModal(id) {
            document.getElementById('deliverOrderId').value = id;
            document.getElementById('deliveryNotes').value = '';
            document.getElementById('deliverAlert').innerHTML = '';
            document.getElementById('deliverModal').classList.add('active');
        }

        function closeDeliverModal() {
            document.getElementById('deliverModal').classList.remove('active');
        }

        async function confirmDeliver() {
            const id = document.getElementById('deliverOrderId').value;
            const notes = document.getElementById('deliveryNotes').value.trim();
            if (!notes) { document.getElementById('deliverAlert').innerHTML = '<div class="alert alert-error">Veuillez entrer les informations de livraison</div>'; return; }

            try {
                const res = await fetch('/api/admin/manual-orders/' + id + '/deliver', {
                    method: 'POST',
                    headers: {'Authorization':`Bearer ${token}`, 'Content-Type':'application/json'},
                    body: JSON.stringify({ deliveryNotes: notes })
                });
                const data = await res.json();
                if (!res.ok) { document.getElementById('deliverAlert').innerHTML = '<div class="alert alert-error">' + (data.error || 'Erreur') + '</div>'; return; }
                document.getElementById('deliverAlert').innerHTML = '<div class="alert alert-success">‚úÖ Livraison enregistr√©e !</div>';
                setTimeout(() => { closeDeliverModal(); loadManualOrders(); }, 1200);
            } catch(err) { document.getElementById('deliverAlert').innerHTML = '<div class="alert alert-error">Erreur: ' + err.message + '</div>'; }
        }

        async function cancelOrder(id) {
            if (!confirm('Annuler cette commande et rembourser le client ?')) return;
            try {
                const res = await fetch('/api/admin/manual-orders/' + id + '/cancel', {method:'POST', headers:{'Authorization':`Bearer ${token}`,'Content-Type':'application/json'}});
                const data = await res.json();
                if (!res.ok) { alert(data.error || 'Erreur'); return; }
                alert('‚úÖ Commande annul√©e et client rembours√© ($' + (data.newBalance || 0).toFixed(2) + ')');
                await loadManualOrders(); await loadUsers();
            } catch(err) { alert(err.message); }
        }
    </script>
</body>
</html>
